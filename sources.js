/**
 * Sources
 */
export const sources = [
  {
    names: ["ABC News"],
    verticalRank: 57,
    horizontalRank: 0,
    urls: ["abcnews.com", "abcnews"]
  },
  {
    names: ["AFP"],
    verticalRank: 62,
    horizontalRank: 0,
    urls: ["afp.com"]
  },
  // TODO: Looks like there's not a good way to distinguish us/canada from
  //       other Al Jazeera news. Disabling for now.
  // {
  //   names: ["Al Jazeera US/Canada News"],
  //   verticalRank: 54,
  //   horizontalRank: -1,
  //   urls: ["aljazeera.com"]
  // },
  {
    names: ["Alternet"],
    verticalRank: 18,
    horizontalRank: -23,
    urls: ["alternet.org"]
  },
  {
    names: ["AP"],
    verticalRank: 62,
    horizontalRank: 0,
    urls: ["www.ap.org"]
  },
  {
    names: ["APNews", "AP News"],
    verticalRank: 62,
    horizontalRank: 0,
    urls: ["www.apnews.com"]
  },
  {
    names: ["Axios"],
    verticalRank: 52,
    horizontalRank: -2,
    urls: ["axios.com"]
  },
  {
    names: ["BBC News", "BBCNews"],
    verticalRank: 54,
    horizontalRank: -3,
    urls: ["bbc.com"]
  },
  {
    names: ["Bipartisan Report"],
    verticalRank: 13,
    horizontalRank: -27,
    urls: ["bipartisanreport.com"]
  },
  {
    names: ["Bloomberg"],
    verticalRank: 58,
    horizontalRank: 4,
    urls: ["bloomberg.com"]
  },
  {
    names: ["Breitbart"],
    verticalRank: 8,
    horizontalRank: 34,
    urls: ["breitbart.com"]
  },
  {
    names: ["Business Insider"],
    verticalRank: 39,
    horizontalRank: 0,
    urls: ["businessinsider.com"]
  },
  {
    names: ["BuzzFeed News", "BuzzFeedNews"],
    verticalRank: 51,
    horizontalRank: -15,
    urls: ["buzzfeednews.com"]
  },
  {
    names: ["CBS News", "CBSNews"],
    verticalRank: 57,
    horizontalRank: 4,
    urls: ["cbsnews.com"]
  },
  {
    names: ["Christian Science Monitor"],
    verticalRank: 54,
    horizontalRank: 6,
    urls: ["csmonitor.com"]
  },
  {
    names: ["CNN"],
    verticalRank: 32,
    horizontalRank: -6,
    urls: ["cnn.com"]
  },
  {
    names: ["Conservative Tribune"],
    verticalRank: 12,
    horizontalRank: 35,
    urls: ["westernjournal.com"]
  },
  {
    names: ["CSPAN"],
    verticalRank: 59,
    horizontalRank: 0,
    urls: ["c-span.org"]
  },
  {
    names: ["Daily Beast"],
    verticalRank: 41,
    horizontalRank: -21,
    urls: ["thedailybeast.com"]
  },
  {
    names: ["Daily Caller"],
    verticalRank: 12,
    horizontalRank: 24,
    urls: ["dailycaller.com"]
  },
  {
    names: ["Daily Kos"],
    verticalRank: 20,
    horizontalRank: -24,
    urls: ["dailykos.com"]
  },
  {
    names: ["Daily Mail"],
    verticalRank: 19,
    horizontalRank: 13,
    urls: ["dailymail.co.uk"]
  },
  {
    names: ["Daily Signal"],
    verticalRank: 30,
    horizontalRank: -15,
    urls: ["dailysignal.com"]
  },
  {
    names: ["Daily Wire"],
    verticalRank: 16,
    horizontalRank: 28,
    urls: ["dailywire.com"]
  },
  {
    names: ["David Wolfe"],
    verticalRank: 2,
    horizontalRank: -32,
    urls: ["davidwolfe.com"]
  },
  {
    names: ["Democracy Now"],
    verticalRank: 48,
    horizontalRank: -19,
    urls: ["democracynow.org"]
  },
  {
    names: ["Drudge Report"],
    verticalRank: 38,
    horizontalRank: 16,
    urls: ["drudgereport.com"]
  },
  {
    names: ["Financial Times"],
    verticalRank: 48,
    horizontalRank: 3,
    urls: ["www.ft.com"]
  },
  {
    names: ["Fiscal Times"],
    verticalRank: 39,
    horizontalRank: 12,
    urls: ["thefiscaltimes.com"]
  },
  {
    names: ["Forbes"],
    verticalRank: 44,
    horizontalRank: 3,
    urls: ["forbes.com"]
  },
  {
    names: ["Foreign Policy"],
    verticalRank: 45,
    horizontalRank: 9,
    urls: ["foreignpolicy.com"]
  },
  {
    names: ["Fortune"],
    verticalRank: 46,
    horizontalRank: 5,
    urls: ["fortune.com"]
  },
  {
    names: ["Forward Progressives"],
    verticalRank: 15,
    horizontalRank: -25,
    urls: ["forward.com"]
  },
  {
    names: ["Fox News", "FoxNews"],
    verticalRank: 20,
    horizontalRank: 27,
    urls: ["foxnews.com"]
  },
  {
    names: ["FreeSpeech TV"],
    verticalRank: 37,
    horizontalRank: -25,
    urls: ["freespeech.org"]
  },
  {
    names: ["Guacamoley"],
    verticalRank: 17,
    horizontalRank: -20,
    urls: ["guacamoley.com"]
  },
  {
    names: ["Huffington Post", "HuffPost"],
    verticalRank: 24,
    horizontalRank: -20,
    urls: ["huffpost.com"]
  },
  {
    names: ["IJR"],
    verticalRank: 41,
    horizontalRank: 2,
    urls: ["ijr.com"]
  },
  {
    names: ["InfoWars"],
    verticalRank: 1,
    horizontalRank: 44,
    urls: ["infowars.com"]
  },
  {
    names: ["Intercept"],
    verticalRank: 49,
    horizontalRank: -23,
    urls: ["theintercept.com"]
  },
  {
    names: ["Jacobin"],
    verticalRank: 47,
    horizontalRank: -28,
    urls: ["jacobinmag.com"]
  },
  {
    names: ["LA Times", "Los Angeles Times"],
    verticalRank: 58,
    horizontalRank: -6,
    urls: ["latimes.com"]
  },
  {
    names: ["Marketwatch"],
    verticalRank: 50,
    horizontalRank: 5,
    urls: ["marketwatch.com"]
  },
  {
    names: ["Mic"],
    verticalRank: 39,
    horizontalRank: -18,
    urls: ["www.mic.com"]
  },
  {
    names: ["Mother Jones"],
    verticalRank: 40,
    horizontalRank: -24,
    urls: ["motherjones.com"]
  },
  {
    names: ["MSNBC"],
    verticalRank: 34,
    horizontalRank: -19,
    urls: ["msnbc.com"]
  },
  {
    names: ["National Enquirer"],
    verticalRank: 6,
    horizontalRank: 10,
    urls: ["nationalenquirer.com"]
  },
  {
    names: ["National Review"],
    verticalRank: 51,
    horizontalRank: 20,
    urls: ["nationalreview.com"]
  },
  {
    names: ["NBC News", "NBCNews"],
    verticalRank: 57,
    horizontalRank: -3,
    urls: ["nbcnews.com"]
  },
  {
    names: ["New Republic"],
    verticalRank: 46,
    horizontalRank: -19,
    urls: ["newrepublic.com"]
  },
  {
    names: ["New York Post", "NY Post"],
    verticalRank: 20,
    horizontalRank: 18,
    urls: ["nypost.com"]
  },
  {
    names: ["New York Times", "NY Times"],
    verticalRank: 52,
    horizontalRank: -5,
    urls: ["nytimes.com"]
  },
  {
    names: ["News and Guts"],
    verticalRank: 31,
    horizontalRank: -15,
    urls: ["newsandguts.com"]
  },
  {
    names: ["NewsMax"],
    verticalRank: 43,
    horizontalRank: -28,
    urls: ["newsmax.com"]
  },
  {
    names: ["NPR", "NPR News", "NPRNews"],
    verticalRank: 56,
    horizontalRank: -5,
    urls: ["npr.org"]
  },
  {
    names: ["OAN"],
    verticalRank: 23,
    horizontalRank: 28,
    urls: ["oann.com"]
  },
  {
    names: ["Occupy Democrats"],
    verticalRank: 9,
    horizontalRank: -30,
    urls: ["occupydemocrats.com"]
  },
  {
    names: ["OZY"],
    verticalRank: 43,
    horizontalRank: 0,
    urls: ["www.ozy.com"]
  },
  {
    names: ["Palmer Report"],
    verticalRank: 8,
    horizontalRank: -34,
    urls: ["palmerreport.com"]
  },
  {
    names: ["Patribotics"],
    verticalRank: 1,
    horizontalRank: -40,
    urls: ["patribotics.blog"]
  },
  {
    names: ["PBS", "PBS News", "PBSNews"],
    verticalRank: 57,
    horizontalRank: -5,
    urls: ["pbs.org"]
  },
  {
    names: ["PJ Media"],
    verticalRank: 17,
    horizontalRank: 26,
    urls: ["pjmedia.com"]
  },
  {
    names: ["Politico"],
    verticalRank: 55,
    horizontalRank: -3,
    urls: ["politico.com"]
  },
  {
    names: ["ProPublica"],
    verticalRank: 46,
    horizontalRank: -5,
    urls: ["propublica.org"]
  },
  {
    names: ["Quartz"],
    verticalRank: 44,
    horizontalRank: -5,
    urls: ["qz.com"]
  },
  {
    names: ["Reason"],
    verticalRank: 42,
    horizontalRank: 18,
    urls: ["/reason.com"]
  },
  {
    names: ["RedState"],
    verticalRank: 11,
    horizontalRank: 29,
    urls: ["redstate.com"]
  },
  {
    names: ["Reuters"],
    verticalRank: 62,
    horizontalRank: 0,
    urls: ["reuters.com"]
  },
  {
    names: ["Second Nexus"],
    verticalRank: 23,
    horizontalRank: -23,
    urls: ["secondnexus.com"]
  },
  {
    names: ["ShareBlue"],
    verticalRank: 33,
    horizontalRank: -21,
    urls: ["shareblue.com"]
  },
  {
    names: ["Slate"],
    verticalRank: 43,
    horizontalRank: -20,
    urls: ["slate.com"]
  },
  {
    names: ["Talking Points Memo"],
    verticalRank: 41,
    horizontalRank: -13,
    urls: ["talkingpointsmemo.com"]
  },
  {
    names: ["The Advocate"],
    verticalRank: 40,
    horizontalRank: -23,
    urls: ["theadvocate.com"]
  },
  {
    names: ["The American Conservative"],
    verticalRank: 33,
    horizontalRank: 28,
    urls: ["theamericanconservative.com"]
  },
  {
    names: ["The Atlantic"],
    verticalRank: 46,
    horizontalRank: -15,
    urls: ["theatlantic.com"]
  },
  {
    names: ["The Blaze"],
    verticalRank: 8,
    horizontalRank: 27,
    urls: ["theblaze.com"]
  },
  {
    names: ["The Economist"],
    verticalRank: 48,
    horizontalRank: 4,
    urls: ["economist.com"]
  },
  {
    names: ["The Federalist"],
    verticalRank: 26,
    horizontalRank: 27,
    urls: ["thefederalist.com"]
  },
  {
    names: ["The Gateway Pundit"],
    verticalRank: 12,
    horizontalRank: 35,
    urls: ["thegatewaypundit.com"]
  },
  {
    names: ["The Guardian"],
    verticalRank: 48,
    horizontalRank: -6,
    urls: ["theguardian.com"]
  },
  {
    names: ["The Hill"],
    verticalRank: 54,
    horizontalRank: 9,
    urls: ["thehill.com"]
  },
  {
    names: ["The Nation"],
    verticalRank: 47,
    horizontalRank: -17,
    urls: ["thenation.com"]
  },
  {
    names: ["The New Yorker"],
    verticalRank: 47,
    horizontalRank: -9,
    urls: ["/newyorker.com"]
  },
  {
    names: ["The Skimm"],
    verticalRank: 49,
    horizontalRank: -2,
    urls: ["theskimm.com"]
  },
  {
    names: ["The Week"],
    verticalRank: 44,
    horizontalRank: -10,
    urls: ["theweek.com"]
  },
  {
    names: ["The Weekly Standard"],
    verticalRank: 46,
    horizontalRank: 18,
    urls: ["weeklystandard.com"]
  },
  {
    names: ["The Young Turks"],
    verticalRank: 27,
    horizontalRank: -24,
    urls: ["tyt.com"]
  },
  {
    names: ["Think Progress"],
    verticalRank: 42,
    horizontalRank: -13,
    urls: ["thinkprogress.org"]
  },
  {
    names: ["Time"],
    verticalRank: 43,
    horizontalRank: -1,
    urls: ["/time.com"]
  },
  {
    names: ["Truthout"],
    verticalRank: 36,
    horizontalRank: -24,
    urls: ["truthout.org"]
  },
  {
    names: ["Twitchy"],
    verticalRank: 14,
    horizontalRank: 29,
    urls: ["twitchy.com"]
  },
  {
    names: ["USA Today"],
    verticalRank: 52,
    horizontalRank: 0,
    urls: ["usatoday.com"]
  },
  {
    names: ["Vanity Fair"],
    verticalRank: 38,
    horizontalRank: -12,
    urls: ["vanityfair.com"]
  },
  {
    names: ["Vice"],
    verticalRank: 42,
    horizontalRank: -10,
    urls: ["vice.com"]
  },
  {
    names: ["Vox", "Vox News", "VoxNews"],
    verticalRank: 43,
    horizontalRank: -16,
    urls: ["vox.com"]
  },
  {
    names: ["Wall Street Journal", "Wall Street Journal"],
    verticalRank: 53,
    horizontalRank: 11,
    urls: ["wsj.com"]
  },
  {
    names: ["Washington Examiner"],
    verticalRank: 35,
    horizontalRank: 18,
    urls: ["washingtonexaminer.com"]
  },
  {
    names: ["Washington Free Beacon"],
    verticalRank: 41,
    horizontalRank: 24,
    urls: ["freebeacon.com"]
  },
  {
    names: ["Washington Monthly"],
    verticalRank: 30,
    horizontalRank: -23,
    urls: ["washingtonmonthly.com"]
  },
  {
    names: ["Washington Post"],
    verticalRank: 51,
    horizontalRank: -10,
    urls: ["washingtonpost.com"]
  },
  {
    names: ["Washington Times"],
    verticalRank: 33,
    horizontalRank: 20,
    urls: ["washingtontimes.com"]
  },
  {
    names: ["WND"],
    verticalRank: 4,
    horizontalRank: 36,
    urls: ["wnd.com"]
  },
  {
    names: ["Wonkette"],
    verticalRank: 12,
    horizontalRank: -34,
    urls: ["wonkette.com"]
  },
  {
    names: ["WorldTruth.Tv"],
    verticalRank: 1,
    horizontalRank: 20,
    urls: ["worldtruth.tv"]
  }
];

/**
 * Political Bias (horizontal rank)
 */
const politicalBias = [
  {
    description: "Most Extreme Left",
    range: [-42, -30]
  },
  {
    description: "Hyper-Partisan Left",
    range: [-29, -18]
  },
  {
    description: "Skews Left",
    range: [-17, -6]
  },
  {
    description: "Neutral (minimal or balanced bias)",
    range: [-5, 5]
  },
  {
    description: "Skews Right",
    range: [6, 17]
  },
  {
    description: "Hyper-Partisan Right",
    range: [18, 29]
  },
  {
    description: "Most Extreme Right",
    range: [30, 42]
  }
];

/**
 * Overall Quality (vertical rank)
 */
const overallQuality = [
  {
    description: "Contains Inaccurate/Fabricated Information",
    range: [0, 8]
  },
  {
    description: "Propaganda/Contains Misleading Information",
    range: [9, 16]
  },
  {
    description: "Selective or Incomplete; Unfair Persuasion",
    range: [17, 24]
  },
  {
    description: "Opinion; Fair Persuasion",
    range: [25, 32]
  },
  {
    description: "Analysis",
    range: [33, 40]
  },
  {
    description: "Complex Analysis OR Mix of Fact Reporting and Analysis",
    range: [41, 48]
  },
  {
    description: "Fact Reporting",
    range: [49, 56]
  },
  {
    description: "Original Fact Reporting",
    range: [57, 64]
  }
];

/**
 * Color boxes
 */
const colorBoxes = [
  {
    description: "News",
    color: "green",
    horizontalRange: [-18, 18],
    verticalRange: [45, 64]
  },
  {
    description: "Fair interpretations of the news",
    color: "yellow",
    horizontalRange: [-22, 22],
    verticalRange: [24, 53]
  },
  {
    description: "Extreme/Unfair interpretations of the news",
    color: "orange",
    horizontalRange: [-42, -23],
    verticalRange: [20, 53]
  },
  {
    description: "Extreme/Unfair interpretations of the news",
    color: "orange",
    horizontalRange: [23, 42],
    verticalRange: [20, 53]
  },
  {
    description: "Extreme/Unfair interpretations of the news",
    color: "orange",
    horizontalRange: [-42, 42],
    verticalRange: [16, 24]
  },
  {
    description: "Nonsense damaging to public discourse",
    color: "red",
    horizontalRange: [-42, 42],
    verticalRange: [0, 20]
  }
];

/**
 * Map of color code keyed by color class
 */
const colorMap = {
  green: "#096b09",
  green_yellow: "#61ab1b",
  yellow: "#acad00",
  yellow_orange: "#f6b60a",
  orange: "#ed6d12",
  orange_red: "#ff5c2f",
  red: "#ff0000"
};

/**
 * Create media bias css to be injected into the page
 */
export function createMediaBiasCss() {
  const colorClasses = Object.keys(colorMap);
  const linkStyles = colorClasses.map(colorClass => {
    const colorCode = colorMap[colorClass];

    return `
      a.${colorClass}, 
      a.${colorClass} * {
        color: ${colorCode} !important;
      }
    `;
  });

  return `<style id="mediaBias">${linkStyles.join("")}</style>`;
}

/**
 * Find the source for a link
 *
 * @param {HTMLAnchorElement} link
 */
export function findSource(link) {
  return (
    findSourceFromLinkHref(link) ||
    findSourceFromLinkText(link) ||
    findSourceForGoogleNewsLink(link)
  );
}

/**
 * Find news source from a link's href
 *
 * @param {HTMLAnchorElement} link
 */
export function findSourceFromLinkHref(link) {
  const linkHref = link.href;

  // Find the source
  const source = sources.find(source => {
    // Find source url that matches the link href
    const matchingUrl = source.urls.find(url => {
      return linkHref.includes(url);
    });

    // Return whether we found a matching source url
    return !!matchingUrl;
  });

  return source;
}

/**
 * Find news source from a link's text
 *
 * @param {HTMLAnchorElement} link
 */
export function findSourceFromLinkText(link) {
  const linkText = link.innerText;

  // Allow for name variations
  const nameVariationRx = new RegExp("(^THE )|(\\.COM$)");

  // Find the source
  const source = sources.find(source => {
    // Find source name that matches the link text
    const matchingName = source.names.find(sourceName => {
      // Check for match (allowing for name variations)
      return (
        linkText.toUpperCase().replace(nameVariationRx, "") ===
        sourceName.toUpperCase().replace(nameVariationRx, "")
      );
    });

    // Return whether we found a matching source name
    return !!matchingName;
  });

  return source;
}

/**
 * Find news source for a link from news.google.com
 *
 * @param {HTMLAnchorElement} link
 */
function findSourceForGoogleNewsLink(link) {
  if (link.host !== "news.google.com") {
    return;
  }

  // Find whether link is for an article
  const $link = $(link);
  const $article = $link.closest("article");
  if (!$article.length) {
    return;
  }

  // Find the article source
  let source;
  const articleLinks = $article.find("a").toArray();
  for (let i = 0, len = articleLinks.length; i < len; i++) {
    const articleLink = articleLinks[i];

    source = findSourceFromLinkHref(articleLink);
    if (source) {
      break;
    }

    source = findSourceFromLinkText(articleLink);
    if (source) {
      break;
    }
  }

  return source;
}

/**
 * Find the political bias of a news source
 *
 * @param source
 */
export function findBias(source) {
  const rank = source.horizontalRank;
  return politicalBias.find(bias => {
    return bias.range[0] <= rank && rank <= bias.range[1];
  });
}

/**
 * Find the overall quality of a news source
 *
 * @param source
 */
export function findQuality(source) {
  const rank = source.verticalRank;
  const quality = overallQuality.find(quality => {
    return quality.range[0] <= rank && rank <= quality.range[1];
  });

  return quality;
}

/**
 * Find the color box(es) a news source falls in
 *
 * @param source
 */
export function findColorBoxes(source) {
  const boxes = colorBoxes.filter(box => {
    const isInHorizontalRange =
      box.horizontalRange[0] <= source.horizontalRank &&
      source.horizontalRank <= box.horizontalRange[1];

    const isInVerticalRange =
      box.verticalRange[0] <= source.verticalRank &&
      source.verticalRank <= box.verticalRange[1];

    return isInHorizontalRange && isInVerticalRange;
  });

  return boxes.length ? boxes : undefined;
}

/**
 * Find the color class for a news source
 *
 * @param source
 */
export function findColorClass(source) {
  const colorBoxes = findColorBoxes(source) || [];
  const colors = colorBoxes.map(colorBox => {
    return colorBox.color;
  });

  // Make sure any duplicates are removed before joining
  return [...new Set(colors)].join("_");
}

/**
 * Find the color code for a news source
 *
 * @param source
 */
export function findColorCode(source) {
  return colorMap[findColorClass(source)];
}

/**
 * Find the description corresponding to a news source's color key(s)
 *
 * @param source
 */
export function findColorDescription(source) {
  const colorBoxes = findColorBoxes(source);
  const categories = colorBoxes.map(colorBox => {
    return colorBox.description;
  });

  // Make sure any duplicates are removed before joining
  return [...new Set(categories)].join(" / ");
}

/**
 * Create a media bias summary for a news source
 *
 * @param source
 */
export function createMediaBiasSummary(source) {
  const colorClass = findColorClass(source) || "COLOR_MISSING";
  const colorKey = colorClass.toUpperCase().replace("_", " / ");
  const quality = findQuality(source);
  const bias = findBias(source);
  const colorDescription = findColorDescription(source);
  const mediaBiasSummary = [
    `SOURCE\n${source.names[0]}\n\n`,
    `${colorKey}\n${colorDescription}\n\n`,
    `POLITICAL BIAS\n${bias.description}\n\n`,
    `OVERALL QUALITY\n${quality.description}`
  ].join("");

  return mediaBiasSummary;
}
